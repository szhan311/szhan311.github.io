<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Reverse time diffusion equation models | Shaorong Zhang (张少荣)</title> <meta name="author" content="Shaorong R. Zhang"> <meta name="description" content=""> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link defer rel="stylesheet" type="text/css" href="https://tikzjax.com/v1/fonts.css"> <script defer src="https://tikzjax.com/v1/tikzjax.js"></script> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://szhan311.github.io//blog/2023/Reverse-time-Diffusion-Equation-Models/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">Shaorong Zhang (张少荣)</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/gallery/">photo gallery</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Reverse time diffusion equation models</h1> <p class="post-meta">December 1, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fa-solid fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/literature-review"> <i class="fa-solid fa-hashtag fa-sm"></i> Literature-review</a>     ·   <a href="/blog/category/diffusion-models"> <i class="fa-solid fa-tag fa-sm"></i> Diffusion-models</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h1 id="what-is-the-reversal-of-a-diffusion-process">What is the reversal of a diffusion process?</h1> <p>Suppose you have an initial distribution \(p(x;0)\)and some drift and diffusion coefficients \(f\)and \(g\). Together, they describe a distribution over the trajectories of your system through time Suppose at time \(T\), the marginal distributionover the trajectories of your system through time. Suppose at time \(T\), the margianl distribution of the states is \(p(x; T)\). Can you describe a diffusion process such that it starts with a distribution \(q(x; 0): = p(x; T)\)and evolves such that the distribution of the trajectories is the same as in the original process but with the tiem reversed? Of course, in such a case we shall have \(q(x; T) = p(x; 0)\).</p> <h1 id="non-linear-case">Non-linear case</h1> <h3 id="ito-sde-and-reverse-time-sde">Ito SDE and reverse time SDE</h3> <p>Given a SDE: \(d \boldsymbol{x} = \boldsymbol{f} (\boldsymbol{x}, t)dt + \boldsymbol{G}(\boldsymbol{X}, t)d\boldsymbol{w}\), where \(\mathbf{f}(\cdot, t): \mathbb{R}^d \rightarrow \mathbb{R}^d\) and \(\mathbf{G}(\cdot, t): \mathbb{R}^d \rightarrow \mathbb{R}^{d \times d}\)</p> <p>The reverse time SDE is given by</p> \[\mathrm{d} \mathbf{x}=\left\{\mathbf{f}(\mathbf{x}, t)-\nabla \cdot\left[\mathbf{G}(\mathbf{x}, t) \mathbf{G}(\mathbf{x}, t)^{\top}\right]-\mathbf{G}(\mathbf{x}, t) \mathbf{G}(\mathbf{x}, t)^{\top} \nabla_{\mathbf{x}} \log p_t(\mathbf{x})\right\} \mathrm{d} t+\mathbf{G}(\mathbf{x}, t) \mathrm{d} \overline{\mathbf{w}}\] <p>where we define \(\nabla \cdot \mathbf{F}(\mathbf{x}):=\left(\nabla \cdot \mathbf{f}^1(\mathbf{x}), \nabla \cdot \mathbf{f}^2(\mathbf{x}), \cdots, \nabla \cdot \mathbf{f}^d(\mathbf{x})\right)^{\top}\) for a matrix-valued function \(\mathbf{F}(\mathbf{x}):=\left(\mathbf{f}^1(\mathbf{x}), \mathbf{f}^2(\mathbf{x}), \cdots, \mathbf{f}^d(\mathbf{x})\right)^{\top}\)</p> <h3 id="a-special-case-diffusion-model-as-sdes">A Special case: Diffusion model as SDEs</h3> \[dX = f(X, t)dt + g(t) dw\] <p>The reverse time SDE is:</p> \[\begin{align} dX &amp;= (f (X, t) - \frac{1}{p(X, t)}\frac{\partial}{\partial X} g^2(t)p(X, t))dt + g(t)dw \\ &amp;= (f (X, t) -g^2(t) \frac{\partial}{\partial X} \log p(X, t))dt + g(t)dw \end{align}\] <h1 id="the-linear-problem">The linear Problem</h1> <ul> <li> <p>Gaussian-Markov processes: \(dx = Ax dt + B dw\), here \(A\)and \(B\)are constant matrices, \(Re[\lambda_i(A)] &lt; 0\)for all \(i\)and \(w(\cdot)\)is a vector Wiener process such that \(x(t)\)is independent of future increments of \(w\), but not of past ones.</p> </li> <li> <p>Solution: \(x(t) = \int_{-\infty}^{t} e^{A(t-s)}Bdw(s)\)</p> </li> <li>A reverse time model: \(dx = \bar A dt + \bar B d \bar w\), where now \(Re[\lambda_i(\bar A)] &gt;0\)for all \(i\).</li> <li> <p>Let \(P = E[x(t) x^T(t)]\), the matrix \(P\)is the solution of the linear matrix equation \(PA^T + AP = -BB^T\), and id nonsingular recisely when rank \([B AB \cdots A^{n-1}B] = n\)</p> <ul> <li>Here \(P\)is the covariance matrix</li> <li> <p>Proof:</p> <ul> <li> <p>take the differential of \(x(t) x^T(t)\): \(d(xx^T) = dxx^T + xdx^T + dxdx'\);</p> </li> <li> <p>Substitude \(dx = Ax dt + B dw\)into the above equation: \(d(xx^T) = (Axdt + Bdw)dx^T + x(A^T x^T dt + B^T dw^T) + (Axdt + Bdw)(A^Tx^T dt + B^T dw^T )\)</p> </li> <li> <p>Taking expection on both sides and using the fact that the expected value of the increments of the Wiener process \(dw\)are zero: \(\frac{d}{dt} E(xx^T) = AE[xx^T] + E[x x^T] A^T + BB^T\)</p> </li> <li> <p>Solving the above matrix differential equations for \(E[xx^T]\) gives \(PA^T + AP = -BB^T\)</p> </li> </ul> </li> </ul> </li> <li> <p>Suppose \(P\)is nonsingular, and define \(d \bar w = dw - B^TP^{-1}xdt, \bar w(0) = 0\)</p> </li> <li> \[dx = (A + BB^TP^{-1})dt + Bd\bar{w}\] </li> </ul> <h1 id="the-kolmogorov-equations">The Kolmogorov Equations</h1> <ul> <li> <p>The Forward Kolmogorov Equation: \(\frac{\partial}{\partial t} p(x ; t \mid y ; s)=-\frac{\partial}{\partial x}(f(x, t) p(x ; t \mid y ; s))+\frac{1}{2} \frac{\partial^2}{\partial x^2}\left(g^2(x ; t) p(x ; t \mid y ; s)\right)\)</p> </li> <li>The Backward Kolmogorov Equation: \(-\frac{\partial}{\partial s} p(x ; t \mid y ; s)=f(y, s) \frac{\partial}{\partial y} p(x ; t \mid y ; s)+\frac{g^2(y ; s)}{2} \frac{\partial^2}{\partial y^2} p(x ; t \mid y ; s)\)</li> <li>\(E[dX] = f(X, t)dt\), \(Var(dX) = g^2(X, t)dt - O(dt^2) \approx g^2(X, t) dt\)</li> </ul> <h2 id="the-forward-kolmogorov-equation">The Forward Kolmogorov Equation</h2> <ul> <li> <p>\(p(x;t \vert y,s) = \int_{-\infty}^{\infty} p(x; t \vert k; m) p(k;m \vert y;s)dk\), where \(p(x; t\vert y, s)\)represents the probability \(p(X_t = t \vert X_s = y)\)with \(t \geq s\)always.</p> </li> <li> \[p(x;t) = \int_{-\infty}^{\infty} p(x; t \vert k; m) p(k;m)dk\] </li> <li>The initial marginal density \(p(x;0)\)determine the entire diffusion process.</li> </ul> \[p(x;t + dt \vert y,s) = \int_{-\infty}^{\infty} p(x; t + dt \vert m;t) p(m;t \vert y;s)dm\] <p>Define: \(\phi_t(\Delta; z) = p(z+\Delta; t+dt\vert z;t)\), then \(m = x = \Delta \Rightarrow dm = -d \Delta\); \(m = \pm \infty \Rightarrow \Delta = \mp \infty\)</p> \[\begin{aligned} m &amp; =x-\Delta \\ \Rightarrow \mathrm{d} m &amp; =-\mathrm{d} \Delta \\ m= \pm \infty &amp; \Rightarrow \Delta=\mp \infty \\ \Rightarrow p(x ; t+\mathrm{d} t \mid y ; s) &amp; =-\int_{\infty}^{-\infty} \phi_t(\Delta ; m) p(m ; t \mid y ; s) \mathrm{d} \Delta \\ &amp; =\int_{-\infty}^{+\infty} \phi_t(\Delta ; m) p(m ; t \mid y ; s) \mathrm{d} \Delta\end{aligned}\] <p>Next Taylor expand the entir function within the integral with respect to \(m\)around \(x\):</p> \[\begin{aligned} p(x ; t+\mathrm{d} t \mid y ; s) &amp; =\int_{-\infty}^{+\infty} \phi_t(\Delta ; x) p(x ; t \mid y ; s) \mathrm{d} \Delta \\ &amp; -\int_{-\infty}^{+\infty} \Delta \frac{\partial}{\partial x} \phi_t(\Delta ; x) p(x ; t \mid y ; s) \mathrm{d} \Delta \\ &amp; +\int_{-\infty}^{+\infty} \frac{\Delta^2}{2} \frac{\partial^2}{\partial x^2} \phi_t(\Delta ; x) p(x ; t \mid y ; s) \mathrm{d} \Delta\end{aligned}\] <p>Using the fact that \(\phi_t\)integrates to 1 over \(\Delta\):</p> \[\begin{aligned} p(x ; t+\mathrm{d} t \mid y ; s)-p(x ; t \mid y ; s) &amp; =-\frac{\partial}{\partial x}\left(\mathbb{E}_{\Delta \sim \phi_t(; x)}[\Delta] p(x ; t \mid y ; s)\right) \\ &amp; +\frac{1}{2} \frac{\partial^2}{\partial x^2}\left(\mathbb{E}_{\Delta \sim \phi_t(; x)}\left[\Delta^2\right] p(x ; t \mid y ; s)\right) \\ &amp; \vdots\end{aligned}\] <p>Define</p> \[\begin{aligned} \mathbb{E}_{\Delta \sim \phi_t(; x)}[\Delta] &amp; :=f(x, t) \mathrm{d} t \\ \mathbb{E}_{\Delta \sim \phi_t(; x)}\left[\Delta^2\right] &amp; :=g^2(x, t) \mathrm{d} t\end{aligned}\] <p>Dividing by \(dt\)on both the sides we get the partial differential equation:</p> \[\frac{\partial}{\partial t} p(x ; t \mid y ; s)=-\frac{\partial}{\partial x}(f(x, t) p(x ; t \mid y ; s))+\frac{1}{2} \frac{\partial^2}{\partial x^2}\left(g^2(x ; t) p(x ; t \mid y ; s)\right)\] <p>\(dX \sim \phi_t(;X)\), \(E[dX] = f(X, t)dt\), \(Var(dX) = g^2(X, t)dt - O(dt^2) \approx g^2(X, t) dt\)</p> <p>The function \(f\)is called drift coefficient of our diffusion coefficient, and \(g\)is our diffusion coefficient.</p> <p>\(dX = f(X, t)dt + g(X, t) dw\), where \(dw \sim D\)such that \(D\)is sime distribution with a varience \(dt\)and a mean of \(0\). This diffusion is called Ito diffusion SDE.</p> <p>We can always consider \(D\)to be Gaussian distribution, \(\int_0^{\frac{1}{N}} dw \sim \mathcal{N}(0, \frac{1}{N})\) The unconditioned forward equation:</p> \[\frac{\partial}{\partial t} p(x ; t)=-\frac{\partial}{\partial x}(f(x, t) p(x ; t))+\frac{1}{2} \frac{\partial^2}{\partial x^2}\left(g^2(x ; t) p(x ; t)\right)\] <h2 id="the-backward-kolmogorov-equation">The Backward Kolmogorov Equation</h2> <p>\(\begin{aligned} p(x ; t \mid y ; s-\mathrm{d} s) &amp; =\int_{-\infty}^{+\infty} \phi_{s-\mathrm{d} s}(\Delta ; y) p(x ; t \mid y+\Delta ; s) \mathrm{d} \Delta \\ &amp; =\int_{-\infty}^{+\infty} \phi_{s-\mathrm{d} s}(\Delta ; y) p(x ; t \mid y ; s) \mathrm{d} \Delta \\ &amp; +\int_{-\infty}^{+\infty} \phi_{s-\mathrm{d} s}(\Delta ; y) \Delta \frac{\partial}{\partial y} p(x ; t \mid y ; s) \mathrm{d} \Delta \\ &amp; +\int_{-\infty}^{+\infty} \phi_{s-\mathrm{d} s}(\Delta ; y) \frac{\Delta^2}{2} \frac{\partial^2}{\partial y^2} p(x ; t \mid y ; s) \mathrm{d} \Delta \\ &amp; \vdots\end{aligned}\)</p> \[-\frac{\partial}{\partial s} p(x ; t \mid y ; s)=f(y, s) \frac{\partial}{\partial y} p(x ; t \mid y ; s)+\frac{g^2(y ; s)}{2} \frac{\partial^2}{\partial y^2} p(x ; t \mid y ; s)\] <p>Then the reverse SDE:</p> \[\mathrm{d} X=\left(f(X, t)-\frac{1}{p(X, t)} \frac{\partial}{\partial X} g^2(X, t) p(X, t)\right) \mathrm{d} t+g(X, t) \mathrm{d} w\] <p>Proof see the original paper</p> <p>Reference:</p> <p><a href="https://www.vanillabug.com/posts/sde/" rel="external nofollow noopener" target="_blank">https://www.vanillabug.com/posts/sde/</a> <a href="https://ludwigwinkler.github.io/blog/FokkerPlanck/" rel="external nofollow noopener" target="_blank">https://ludwigwinkler.github.io/blog/FokkerPlanck/</a> <a href="https://ludwigwinkler.github.io/blog/Kramers/" rel="external nofollow noopener" target="_blank">https://ludwigwinkler.github.io/blog/Kramers/</a></p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/EDM/">Elucidating the Design Space of Diffusion-Based Generative Models</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/Wasserstein-Lagrangian-Flows/">A Computational Framework For Solving Wassertein Lagrangian Flows</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/CLD/">Score-based generative modeling with critically-damped Langevin diffusion</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/DPM/">Deep Unsupervised Learning using Nonequilibrium Thermodynamics</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/Consistency-model/">Consistency models</a> </li> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Shaorong R. Zhang. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?07b8786bab9b4abe90d10e61f7d12ff7" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script>var wechatModal=document.getElementById("WeChatMod"),wechatBtn=document.getElementById("WeChatBtn");wechatBtn.onclick=function(){wechatModal.style.display="block"},window.onclick=function(t){t.target==wechatModal&&(wechatModal.style.display="none")};</script> </body> </html>